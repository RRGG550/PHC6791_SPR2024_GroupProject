---
title: "PHC6791_SGP_Spatial Mapping"
author: "Rylen Garlitz"
date: '`r Sys.Date()`'
output: html_document
---

libraries
```{r}
library(tidyverse)
library(sf)
#library(rnaturalearth)
#library(rnaturalearthdata)
library(maps)
library(leaflet) #Interactive Map Plotting
library(osrm) #Routing

```


Read in some shit
```{r}
markets <-read.csv("data/SNAP Retailer Location data.csv")
str(markets)

markets$Store.Type <- as.factor(markets$Store.Type)

levels(markets$Store.Type)

markets.sf <- st_as_sf(markets, coords = c("Longitude", "Latitude"))
```


## Creating Interactive Spatial Map
```{r}
(map <- leaflet(data = markets) %>% 
  addTiles() %>% 
  addMarkers(lng = markets$Longitude, lat = markets$Latitude, popup = markets$Store.Name))

#Select Points
CircleK2721002 <- markets %>% 
  filter(Store.Name == "Circle K 2721002") %>% 
  select(Longitude, Latitude)

CVS4629 <- markets %>% 
  filter(Store.Name == "CVS Pharmacy 4629") %>% 
  select(Longitude, Latitude)

#Create Dataframe of Coordinates
CVs_CircleK <- data.frame(rbind(CircleK2721002, CVS4629))

#Create Route information
CVS_CircleK.route <- osrmRoute(loc = CVs_CircleK)
CVS_CircleK.route
#20.02 km from points.

#Plot Route Data
(map <- leaflet(data = markets) %>% 
  addTiles() %>% 
  addMarkers(lng = markets$Longitude, lat = markets$Latitude, popup = markets$Store.Name, icon = store.icons[markets$Icons]))


markets$Icons <- unlist(markets$Icons)
```



## Crime Response Data

```{r}
crime <- read.csv("data/Crime_Responses_20240212.csv")

crime$Incident.Type <- as.factor(crime$Incident.Type)

levels(crime$Incident.Type)


#Remove NAs
crime <- crime %>% 
  na.omit()

crime %>% 
  group_by(Incident.Type) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  print(n = 200)


# Remove Crime data not in Alachua County.
crime.filter1 <- crime %>%  
  filter(!Longitude < -82.7 | !Longitude > -82 | !Latitude < 29.4 | !Latitude > 29.95 )

```



## Bus Data

```{r}
bus.stops <- read_sf("data/RTSBusStops_Spring2024", layer = "RTSBusStops_Fall2023")
bus.stops

bus.stops <- bus.stops %>% 
  filter(!OBJECTID == "0")

(bus.stop.map <- leaflet(data = bus.stops) %>% 
  addTiles() %>% 
  addCircleMarkers(lng = bus.stops$LONGITUDE, lat = bus.stops$LATITUDE, popup = bus.stops$STOP_NAME, radius = 0.5, fillOpacity = 1, color = "black"))

bus.routes <- st_read("data/RTSBusRoutes_Spring2024") %>% 
  st_transform('+proj=longlat +datum=WGS84')

head(bus.routes)

#Test Plotting LINESTRING
plot(st_geometry(bus.routes))

leaflet(bus.routes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolylines(data = bus.routes, opacity = 1, color = "purple", label = bus.routes$route_id, weight = 2) %>% 
  addCircleMarkers(lng = bus.stops$LONGITUDE, lat = bus.stops$LATITUDE, popup = bus.stops$STOP_NAME, weight = 1, radius = 2, fillOpacity = 1) %>% 
  addCircleMarkers(lng = markets$Longitude, lat = markets$Latitude, popup = markets$Store.Name, weight = 2, radius = 4, fillOpacity = 1, color = "red")
```

### Change the Icons (NOT WORKING)
```{r}

library(fontawesome)

markets.sf <- markets.sf %>% 
  mutate(Icons = case_when(
    Store.Type == "Supermarket" ~ "Supermarket", 
    Store.Type == "Convenience Store" ~ "ConvenienceStore", 
    Store.Type == "Farmers and Markets" ~ "FarmersMarket", 
    Store.Type == "Grocery Store" ~ "Grocery", 
    Store.Type == "Super Store" ~ "SuperStore", 
    Store.Type == "Specialty Store" ~ "Specialty", 
    Store.Type == "Other" ~ "Other"
  ))

markets.sf$Icons <- as.factor(markets.sf$Icons)
levels(markets.sf$Icons)


store.icons <- awesomeIconList(
  Supermarket = makeAwesomeIcon(
    icon = "shopping-cart", 
    markerColor = "lightred", 
    library= "fa"
  ),
  ConvenienceStore = makeAwesomeIcon(
    icon = "pizza", 
    iconColor = "black",
    markerColor = "blue", 
    library = "ion"
  ), 
  FarmersMarket = makeAwesomeIcon(
    icon = "group",
    markerColor = "green", 
    library = "fa"
  ), 
  Grocery = makeAwesomeIcon(
    icon = "shopping-basket", 
    markerColor = "pink", 
    library = "fa"
  ), 
  SuperStore = makeAwesomeIcon(
    icon = "cubes", 
    markerColor = "purple", 
    library = "fa"
  ), 
  Specialty = makeAwesomeIcon(
    icon = "info", 
    markerColor = "lightgray", 
    library = "fa"
  ), 
  Other = makeAwesomeIcon(
    icon = "asterisk", 
    markerColor = "orange", 
    library = "fa"
  )
)

bus.stop.icon <- makeIcon(
  iconUrl = "https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
)


leaflet(markets.sf) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addAwesomeMarkers(icon = ~store.icons[Icons],
                   label = ~as.character(Store.Name, Store.Type)) %>% 
  addPolylines(data = bus.routes, 
               opacity = 1, 
               color = "purple", 
               popup = paste0(
                     "<b>Route: </b>", 
                     bus.routes$shape_id, 
                     "<br>",
                     "<b>Line: </b>", 
                     bus.routes$route_long
                   ), 
               label = bus.routes$route_id,
               weight = 3) %>% 
  addCircleMarkers(lng = bus.stops$LONGITUDE, 
                   lat = bus.stops$LATITUDE, 
                   popup = paste0(
                     "<b>Stop: </b>", 
                     bus.stops$STOP_NAME, 
                     "<br>",
                     "<b>Line: </b>", 
                     bus.stops$DESCRIPTIO
                   ),
                   weight = 2, 
                   radius = 4, 
                   opacity = 1,
                   fillOpacity = 1)
             
leaflet(bus.stops) %>% 
  addProviderTiles("CartoDB.Positron") %>%
  addMarkers(~LONGITUDE, ~LATITUDE, popup = bus.stops$STOP_NAME, icon = ~bus.stop.icon)      
                   
```











